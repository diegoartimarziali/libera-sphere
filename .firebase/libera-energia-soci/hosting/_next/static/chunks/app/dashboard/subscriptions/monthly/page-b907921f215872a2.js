(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9810],{12163:(e,a,s)=>{Promise.resolve().then(s.bind(s,81543))},81543:(e,a,s)=>{"use strict";s.r(a),s.d(a,{default:()=>E});var t=s(95155),r=s(12115),i=s(20063),l=s(19708),n=s(14585),o=s(13328),c=s(15894),d=s(57368),u=s(67377),m=s(89106),h=s(39179),x=s(84668),p=s(52619),b=s.n(p),f=s(86948),j=s(3998),g=s(60406),v=s(91480),y=s(19201),N=s(92033),w=s(36204),k=s(93169),D=s(7881),A=s(50705),P=s(36304),C=s(18332),S=s(51834),z=s(50909),I=s(76444);function M(e){let{subscription:a,onPurchase:s,isSubmitting:r,hasActiveOrPending:i,onOpenPaymentDialog:l}=e,n=new Date,o=!a.purchaseStartDate||!a.purchaseEndDate||(0,d.d)(n,a.purchaseStartDate.toDate())&&(0,u.Y)(n,a.purchaseEndDate.toDate()),c=a.expiryWarningDate&&(0,d.d)(n,a.expiryWarningDate.toDate());return(0,t.jsxs)(f.Zp,{className:"w-full max-w-lg border-4 bg-gray-50",style:{borderColor:"hsl(var(--primary))"},children:[(0,t.jsxs)(f.aR,{children:[(0,t.jsx)(f.ZB,{className:"text-2xl",children:a.name}),(0,t.jsx)(f.BT,{children:"Acquista l'accesso ai corsi per il periodo di validit\xe0 indicato."})]}),(0,t.jsxs)(f.Wu,{className:"space-y-4",children:[c&&!i&&(0,t.jsxs)(C.Fc,{variant:"warning",children:[(0,t.jsx)(g.A,{className:"h-4 w-4"}),(0,t.jsx)(C.XL,{children:"Abbonamento in Scadenza!"}),(0,t.jsx)(C.TN,{children:"Il tuo attuale abbonamento sta per scadere. Acquistalo per non perdere l'accesso ai corsi."})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between text-lg",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Prezzo"}),(0,t.jsxs)("span",{className:"font-bold text-3xl",children:[a.totalPrice.toFixed(2)," €"]})]}),(0,t.jsxs)("div",{className:"space-y-2 rounded-md border p-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Valido dal"}),(0,t.jsx)("span",{className:"font-semibold",children:(0,m.GP)(a.validityStartDate.toDate(),"dd MMMM yyyy",{locale:x.it})})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Fino al"}),(0,t.jsx)("span",{className:"font-semibold",children:(0,m.GP)(a.validityEndDate.toDate(),"dd MMMM yyyy",{locale:x.it})})]})]}),(0,t.jsxs)("ul",{className:"space-y-2 text-sm pt-2",children:[(0,t.jsxs)("li",{className:"flex items-center",children:[(0,t.jsx)(v.A,{className:"h-4 w-4 mr-2 text-primary flex-shrink-0"}),(0,t.jsx)("span",{style:{color:"hsl(var(--primary))"},children:"Attivazione rapida dopo la conferma del pagamento."})]}),(0,t.jsxs)("li",{className:"flex items-center",children:[(0,t.jsx)(y.A,{className:"h-4 w-4 mr-2 text-primary flex-shrink-0"}),(0,t.jsx)("span",{style:{color:"hsl(var(--primary))"},children:"La copertura assicurativa deve essere gi\xe0 attiva."})]})]})]}),(0,t.jsxs)(f.wL,{className:"flex-col gap-2",children:[(0,t.jsxs)(j.$,{onClick:l,disabled:r||i||!o,className:"w-full text-white font-bold",size:"lg",style:{backgroundColor:"hsl(var(--primary))"},children:[r?(0,t.jsx)(N.A,{className:"animate-spin mr-2"}):null,i?"Pagamento in fase di approvazione":o?"Acquista Ora":"Non ancora acquistabile"]}),(0,t.jsx)(j.$,{asChild:!0,variant:"outline",className:"w-full bg-transparent border-2",style:{color:"hsl(var(--background))",borderColor:"hsl(var(--background))"},children:(0,t.jsxs)(b(),{href:"/dashboard/subscriptions",children:[(0,t.jsx)(w.A,{className:"mr-2 h-4 w-4"}),"Torna Indietro"]})})]})]})}function E(){let[e,a]=(0,r.useState)([]),[m,x]=(0,r.useState)(0),[p]=(0,o.hD)(n.j2),g=(0,i.useRouter)(),{toast:v}=(0,c.dj)(),[y,C]=(0,r.useState)(!0),[E,F]=(0,r.useState)(!1),[B,_]=(0,r.useState)(null),[L,V]=(0,r.useState)(null),[q,O]=(0,r.useState)(null),[T,R]=(0,r.useState)(!1),[U,$]=(0,r.useState)(null),[G,W]=(0,r.useState)(!1);(0,r.useEffect)(()=>{if(p&&Promise.resolve().then(s.bind(s,19708)).then(e=>{let{collection:t,query:r,onSnapshot:i,where:o}=e;i(r(t(n.db,"users",p.uid,"payments"),o("status","==","failed")),async e=>{e.docChanges().forEach(async e=>{if("modified"===e.type){let r=e.doc.data();if(r.bonusUsed>0&&r.awardId){console.log("[Pagamento fallito] Riaccredito bonus:",r);try{let{refundBonus:e}=await s.e(6717).then(s.bind(s,56717));await e(p.uid,r.awardId,r.bonusUsed);let i=await (0,l.getDocs)(t(n.db,"users",p.uid,"userAwards")),o=(await Promise.all(i.docs.map(async e=>{let a=e.data(),s=a.value||0,t=a.residuo||0;if(!a.value&&a.awardId){let e=await (0,l.getDoc)((0,l.doc)(n.db,"awards",a.awardId));e.exists()&&(t=(e.data().value||0)-(a.usedValue||0))}return{id:e.id,value:t,used:a.used||0===t}}))).filter(e=>!e.used&&e.value>0);a(o),x(o.reduce((e,a)=>e+(a.value||0),0)),v({title:"Bonus riaccreditato",description:"Il tuo bonus di ".concat(r.bonusUsed,"€ \xe8 stato riaccreditato perch\xe9 il pagamento non \xe8 stato accettato."),variant:"success"})}catch(e){console.error("Errore durante il rimborso bonus:",e)}}}})})}),!p)return void C(!1);(async()=>{try{let e=await (0,l.getDocs)((0,l.collection)(n.db,"users",p.uid,"userAwards")),s=(await Promise.all(e.docs.map(async e=>{let a=e.data(),s=a.value||0,t=a.residuo||0;if(!a.value&&a.awardId){let e=await (0,l.getDoc)((0,l.doc)(n.db,"awards",a.awardId));e.exists()&&(t=(e.data().value||0)-(a.usedValue||0))}return{id:e.id,value:t,used:a.used||0===t}}))).filter(e=>!e.used&&e.value>0);a(s),x(s.reduce((e,a)=>e+(a.value||0),0));let[t,r,i]=await Promise.all([(0,l.getDocs)((0,l.query)((0,l.collection)(n.db,"subscriptions"),(0,l.where)("type","==","monthly"))),(0,l.getDoc)((0,l.doc)(n.db,"users",p.uid)),(0,l.getDoc)((0,l.doc)(n.db,"settings","bankDetails"))]);i.exists()&&O(i.data());let o=t.docs.map(e=>({id:e.id,...e.data()})),c=r.exists()?r.data():null;V(c);let m=new Date,h=null;if(o.length>0){let e=o.find(e=>!e.purchaseStartDate||!e.purchaseEndDate||(0,d.d)(m,e.purchaseStartDate.toDate())&&(0,u.Y)(m,e.purchaseEndDate.toDate()));if(e)h=e;else{let e=o.find(e=>(0,d.d)(m,e.validityStartDate.toDate())&&(0,u.Y)(m,e.validityEndDate.toDate()));if(e)h=e;else{let e=o.filter(e=>e.purchaseStartDate&&(0,d.d)(e.purchaseStartDate.toDate(),m)).sort((e,a)=>e.purchaseStartDate.toMillis()-a.purchaseStartDate.toMillis());e.length>0&&(h=e[0])}}}_(h)}catch(e){console.error("Error fetching dati:",e),v({title:"Errore",description:"Impossibile caricare i dati.",variant:"destructive"})}finally{C(!1)}})()},[p,v]),(0,r.useEffect)(()=>{m>0&&"online"===U&&$(null)},[m,U]);let Z=async(s,t)=>{F(!0);try{if("online"===t&&m>0){v({title:"Metodo di pagamento non valido",description:"Il pagamento online non \xe8 disponibile quando si utilizzano bonus.",variant:"destructive"}),F(!1);return}let r=0,i=[],o=s.totalPrice;for(let a of e){if(o<=0)break;let e=Math.min(a.value,o);r+=e,o-=e,i.push({id:a.id,value:e})}let c=(0,l.writeBatch)(n.db),d=(0,l.doc)(n.db,"users",p.uid);for(let e of(c.update(d,{subscriptionAccessStatus:"pending",subscriptionPaymentFailed:!1,activeSubscription:{subscriptionId:s.id,name:s.name,type:s.type,purchasedAt:(0,l.serverTimestamp)(),expiresAt:s.validityEndDate}}),i)){let a=(0,l.doc)(n.db,"users",p.uid,"userAwards",e.id),s=await (0,l.getDoc)(a);if(s.exists()){let t=s.data(),r=t.value||0,i=(t.usedValue||0)+e.value,l=Math.max(0,r-i);c.update(a,{used:0===l,usedValue:i,residuo:l})}}await c.commit();let u=await (0,l.getDocs)((0,l.collection)(n.db,"users",p.uid,"userAwards")),h=(await Promise.all(u.docs.map(async e=>{let a=e.data(),s=a.value||0,t=a.residuo||0;if(!a.value&&a.awardId){let e=await (0,l.getDoc)((0,l.doc)(n.db,"awards",a.awardId));e.exists()&&(t=(e.data().value||0)-(a.usedValue||0))}return{id:e.id,value:t,used:a.used||0===t}}))).filter(e=>!e.used&&e.value>0);a(h),x(h.reduce((e,a)=>e+(a.value||0),0));let b=(0,l.collection)(n.db,"users",p.uid,"payments"),f=i.map(e=>e.id);await (0,l.addDoc)(b,{createdAt:(0,l.serverTimestamp)(),description:"Abbonamento ".concat(s.name," (").concat(s.totalPrice.toFixed(2)," €)"),amount:Math.max(0,s.totalPrice-r),paymentMethod:t,status:"pending",type:"subscription",userId:p.uid,bonusUsed:r,awardId:1===f.length?f[0]:f}),v({title:"Richiesta Inviata!",description:"Pagamento: €".concat(Math.max(0,s.totalPrice-r).toFixed(2),". Bonus usati: €").concat(r.toFixed(2),".")}),"online"===t&&s.sumupLink&&Math.max(0,s.totalPrice-r)>0&&window.open(s.sumupLink,"_blank"),V(e=>e?{...e,subscriptionAccessStatus:"pending",subscriptionPaymentFailed:!1}:null),R(!1),g.push("/dashboard")}catch(e){console.error("Error purchasing subscription: ",e),v({title:"Errore",description:"Impossibile completare l'acquisto. Riprova.",variant:"destructive"})}finally{F(!1)}};if(y)return(0,t.jsx)("div",{className:"flex h-full w-full items-center justify-center",children:(0,t.jsx)(N.A,{className:"h-16 w-16 animate-spin text-primary"})});let J=(null==L?void 0:L.subscriptionAccessStatus)==="active"||(null==L?void 0:L.subscriptionAccessStatus)==="pending";return(0,t.jsx)("div",{className:"flex w-full flex-col items-center justify-center",children:B?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(M,{subscription:B,onPurchase:Z,isSubmitting:E,hasActiveOrPending:!!J,onOpenPaymentDialog:()=>R(!0)}),(0,t.jsxs)("div",{className:"w-full max-w-lg my-4 p-4 border-2 rounded-lg bg-green-50",style:{borderColor:"#10b981"},children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,t.jsx)(h.A,{className:"h-6 w-6 text-yellow-500"}),(0,t.jsx)("span",{className:"font-bold",style:{color:"#059669"},children:"Bonus disponibili:"}),(0,t.jsxs)("span",{className:"text-lg font-bold",style:{color:"#059669"},children:["€",m.toFixed(2)]})]}),e.length>0?(0,t.jsx)("ul",{className:"text-sm",children:e.map(e=>(0,t.jsxs)("li",{className:"flex justify-between",children:[(0,t.jsxs)("span",{className:"font-bold",style:{color:"#059669"},children:["ID: ",e.id]}),(0,t.jsxs)("span",{className:"font-bold",style:{color:"#059669"},children:["Valore: €","number"==typeof e.value?e.value.toFixed(2):"0.00"]})]},e.id))}):(0,t.jsx)("span",{className:"text-muted-foreground",children:"Nessun bonus disponibile"})]}),(0,t.jsx)(S.lG,{open:T,onOpenChange:R,children:(0,t.jsxs)(S.Cf,{className:"bg-gray-100 [&>button]:text-[hsl(var(--background))]",children:[(0,t.jsxs)(S.c7,{children:[(0,t.jsx)(S.L3,{style:{color:"hsl(var(--background))"},children:"Scegli Metodo di Pagamento"}),(0,t.jsxs)(S.rr,{className:"text-base",children:["Prezzo abbonamento: ",(0,t.jsxs)("b",{children:["€",B.totalPrice.toFixed(2)]}),(0,t.jsx)("br",{}),"Bonus utilizzabili: ",(0,t.jsxs)("b",{children:["€",m.toFixed(2)]}),(0,t.jsx)("br",{}),(0,t.jsxs)("span",{style:{color:"#059669"},children:["Prezzo finale: ",(0,t.jsxs)("b",{children:["€",Math.max(0,B.totalPrice-m).toFixed(2)]})]}),(0,t.jsx)("br",{}),0===Math.max(0,B.totalPrice-m)&&(0,t.jsxs)("span",{style:{color:"#059669"},children:["Residuo bonus dopo il pagamento: ",(0,t.jsxs)("b",{children:["€",(m-B.totalPrice).toFixed(2)]})]})]})]}),Math.max(0,B.totalPrice-m)>0?(0,t.jsxs)(z.z,{value:U||"",onValueChange:e=>$(e),className:"space-y-4 py-4",children:[(0,t.jsxs)(I.J,{htmlFor:"online",className:"flex cursor-pointer items-start space-x-4 rounded-md border-2 p-4 transition-all bg-white hover:bg-accent/50 has-[:checked]:border-primary has-[:checked]:bg-primary/5 ".concat(m>0?"opacity-50 cursor-not-allowed":""),style:{borderColor:"hsl(var(--background))"},children:[(0,t.jsx)(z.C,{value:"online",id:"online",className:"mt-1",style:{borderColor:"hsl(var(--background))"},disabled:m>0}),(0,t.jsxs)("div",{className:"flex-1 space-y-1",children:[(0,t.jsxs)("h4",{className:"font-semibold",style:{color:"hsl(var(--background))"},children:["Online (Carta di Credito)",m>0&&(0,t.jsx)("span",{className:"text-red-500 ml-2",children:"(Non disponibile con bonus)"})]}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:m>0?"Il pagamento online non \xe8 disponibile quando si utilizzano bonus. Utilizza bonifico bancario o pagamento in sede.":"Paga in modo sicuro con SumUp. Verrai reindirizzato al sito del gestore, a pagamento effettuato torna all'app per conferma e concludere l'iscrizione ai corsi."})]}),(0,t.jsx)(k.A,{className:"h-6 w-6 ".concat(m>0?"text-gray-400":"text-muted-foreground")})]}),(0,t.jsxs)(I.J,{htmlFor:"bank_transfer",className:"flex cursor-pointer items-start space-x-4 rounded-md border-2 p-4 transition-all bg-white hover:bg-accent/50 has-[:checked]:border-primary has-[:checked]:bg-primary/5",style:{borderColor:"hsl(var(--background))"},children:[(0,t.jsx)(z.C,{value:"bank_transfer",id:"bank_transfer",className:"mt-1",style:{borderColor:"hsl(var(--background))"}}),(0,t.jsxs)("div",{className:"flex-1 space-y-1",children:[(0,t.jsx)("h4",{className:"font-semibold",style:{color:"hsl(var(--background))"},children:"Bonifico Bancario"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"Visualizza i dati per effettuare il bonifico. L'attivazione richiede verifica manuale."})]}),(0,t.jsx)(D.A,{className:"h-6 w-6 text-muted-foreground"})]}),(0,t.jsxs)(I.J,{htmlFor:"in_person",className:"flex cursor-pointer items-start space-x-4 rounded-md border-2 p-4 transition-all bg-white hover:bg-accent/50 has-[:checked]:border-primary has-[:checked]:bg-primary/5",style:{borderColor:"hsl(var(--background))"},children:[(0,t.jsx)(z.C,{value:"in_person",id:"in_person",className:"mt-1",style:{borderColor:"hsl(var(--background))"}}),(0,t.jsxs)("div",{className:"flex-1 space-y-1",children:[(0,t.jsx)("h4",{className:"font-semibold",style:{color:"hsl(var(--background))"},children:"In Sede (Contanti o Bancomat)"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"Paga direttamente in palestra. L'attivazione richiede verifica manuale."})]}),(0,t.jsx)(A.A,{className:"h-6 w-6 text-muted-foreground"})]})]}):(0,t.jsx)("div",{className:"py-4 text-center text-green-700 font-semibold",children:"Il tuo abbonamento \xe8 interamente coperto dai bonus. Nessun pagamento richiesto."}),(0,t.jsxs)(S.Es,{className:"justify-between gap-8 px-4",children:[(0,t.jsx)(j.$,{variant:"ghost",onClick:()=>R(!1),className:"bg-transparent border-2",style:{borderColor:"hsl(var(--background))",color:"hsl(var(--background))"},children:"Annulla"}),(0,t.jsxs)(j.$,{onClick:()=>{0===Math.max(0,B.totalPrice-m)?Z(B,"bonus"):(()=>{if(!B||!U)return v({title:"Selezione mancante",description:"Per favore, scegli un metodo di pagamento.",variant:"destructive"});"bank_transfer"===U?W(!0):Z(B,U)})()},disabled:E,className:"text-white font-bold",style:{backgroundColor:"hsl(var(--primary))"},size:"lg",children:[E&&(0,t.jsx)(N.A,{className:"animate-spin mr-2"}),"Conferma"]})]})]})}),(0,t.jsx)(S.lG,{open:G,onOpenChange:W,children:(0,t.jsxs)(S.Cf,{className:"bg-gray-100 [&>button]:text-[hsl(var(--background))]",children:[(0,t.jsx)(S.c7,{children:(0,t.jsx)(S.L3,{style:{color:"hsl(var(--background))"},children:"Dati per Bonifico Bancario"})}),(0,t.jsxs)("div",{className:"space-y-4 py-4 text-sm",children:[q?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("p",{className:"font-semibold text-black",children:"Intestatario:"}),(0,t.jsx)("p",{className:"text-black",children:q.recipientName})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("p",{className:"font-semibold text-black",children:"Banca:"}),(0,t.jsx)("p",{className:"text-black",children:q.bankName})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("p",{className:"font-semibold text-black",children:"IBAN:"}),(0,t.jsx)("p",{className:"font-mono bg-muted p-2 rounded-md text-black",children:q.iban})]})]}):(0,t.jsx)(N.A,{className:"h-6 w-6 animate-spin"}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("p",{className:"font-semibold text-black",children:"Importo:"}),(0,t.jsxs)("p",{className:"text-black",children:[B.totalPrice.toFixed(2)," €"]})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("p",{className:"font-semibold text-black",children:"Causale:"}),(0,t.jsx)("p",{className:"font-mono bg-muted p-2 rounded-md text-black",children:"".concat(B.name," ").concat((null==L?void 0:L.name)||""," ").concat((null==L?void 0:L.surname)||"").trim()})]})]}),(0,t.jsx)(S.Es,{children:(0,t.jsx)(j.$,{onClick:()=>{B&&(Z(B,"bank_transfer"),g.push("/dashboard")),W(!1)},className:"w-full bg-green-600 hover:bg-green-700 text-white font-bold",children:"Ho copiato i dati, invia richiesta"})})]})})]}):(0,t.jsxs)(f.Zp,{className:"w-full max-w-lg",children:[(0,t.jsxs)(f.aR,{children:[(0,t.jsx)(f.ZB,{children:"Nessun Abbonamento Disponibile"}),(0,t.jsx)(f.BT,{children:"Al momento non ci sono abbonamenti mensili acquistabili. Contatta la segreteria per maggiori informazioni."})]}),(0,t.jsx)(f.Wu,{children:(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-48 text-center text-muted-foreground border-2 border-dashed rounded-lg",children:[(0,t.jsx)(P.A,{className:"h-16 w-16 mb-4"}),(0,t.jsx)("p",{children:"Torna a trovarci presto!"})]})}),(0,t.jsx)(f.wL,{children:(0,t.jsx)(j.$,{asChild:!0,variant:"outline",className:"w-full",children:(0,t.jsxs)(b(),{href:"/dashboard/subscriptions",children:[(0,t.jsx)(w.A,{className:"mr-2 h-4 w-4"}),"Torna Indietro"]})})})]})})}}},e=>{e.O(0,[2992,7138,4909,3947,7134,3328,9106,1930,2445,531,2619,7079,5899,9002,8441,1255,7358],()=>e(e.s=12163)),_N_E=e.O()}]);