(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[835],{15738:(e,t,i)=>{Promise.resolve().then(i.bind(i,85938))},85938:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>P});var a=i(95155),r=i(12115),l=i(20063),s=i(22544),c=i(66942),n=i(98734),o=i(14585),d=i(13328),f=i(19708),u=i(58134),m=i(52619),x=i.n(m),p=i(3998),h=i(86948),j=i(41052),v=i(65142),b=i(76444),y=i(15894),N=i(92033),g=i(18527),D=i(97776),w=i(36654),C=i(89106),F=i(19056);let I=n.Ik({certificateFile:n.Nl(File).optional(),expiryDate:n.Yj({required_error:"La data di scadenza \xe8 obbligatoria."})});function P(){let[e,t]=(0,d.hD)(o.j2),i=(0,l.useRouter)(),{toast:n}=(0,y.dj)(),[m,P]=(0,r.useState)(!0),[_,k]=(0,r.useState)(!1),[A,M]=(0,r.useState)(null),[S,T]=(0,r.useState)(null),U=(0,s.mN)({resolver:(0,c.u)(I),defaultValues:{certificateFile:void 0,expiryDate:""}}),z=(0,r.useCallback)(async e=>{let t=(0,f.doc)(o.db,"users",e),i=await (0,f.getDoc)(t);if(i.exists()){let e=i.data();if(e.medicalInfo){var a;let t={type:e.medicalInfo.type,fileUrl:e.medicalInfo.fileUrl,fileName:e.medicalInfo.fileName,expiryDate:null==(a=e.medicalInfo.expiryDate)?void 0:a.toDate()};T(t),U.reset({expiryDate:(e=>{if(!e)return;let t=e instanceof f.Timestamp?e.toDate():e;return(0,C.GP)(t,"yyyy-MM-dd")})(t.expiryDate)||""}),t.fileName&&M(t.fileName)}}},[U]);(0,r.useEffect)(()=>{e?(P(!0),z(e.uid).finally(()=>P(!1))):t||P(!1)},[e,t,z]);let E=e=>{var t;let i=null==(t=e.target.files)?void 0:t[0];if(i){if(!["application/pdf","image/jpeg","image/png"].includes(i.type)){n({variant:"destructive",title:"Tipo di file non valido",description:"Puoi caricare solo file PDF, JPG o PNG."}),e.target.value="";return}U.setValue("certificateFile",i,{shouldValidate:!0}),M(i.name)}},G=async t=>{if(!e)return void n({variant:"destructive",title:"Errore",description:"Utente non autenticato."});if(!t.certificateFile&&!(null==S?void 0:S.fileUrl))return void n({variant:"destructive",title:"File Mancante",description:"Per favore, carica il file del certificato."});k(!0);try{let a=(0,f.doc)(o.db,"users",e.uid),r={type:"certificate",updatedAt:(0,f.serverTimestamp)()};if(t.expiryDate){if(t.certificateFile){let i=(0,C.GP)(new Date,"yyyy-MM-dd'T'HH-mm-ss"),a="certificato_medico_".concat(i,".").concat(t.certificateFile.name.split(".").pop()),l=(0,u.KR)(o.IG,"medical-certificates/".concat(e.uid,"/").concat(a)),s=await (0,u.D)(l,t.certificateFile);r.fileUrl=await (0,u.qk)(s.ref),r.fileName=a}else S&&(r.fileUrl=S.fileUrl,r.fileName=S.fileName);r.expiryDate=f.Timestamp.fromDate((0,F.H)(t.expiryDate))}let l={medicalCertificateSubmitted:!0,medicalInfo:r,updatedAt:(0,f.serverTimestamp)(),medicalCertificateStatus:null};await (0,f.updateDoc)(a,l),n({title:"Certificato Aggiornato!",description:"Le tue informazioni mediche sono state salvate con successo."}),i.push("/dashboard")}catch(e){console.error("Errore durante l'invio dei dati medici:",e),n({variant:"destructive",title:"Errore",description:"Impossibile salvare i dati. Riprova."})}finally{k(!1)}};return m?(0,a.jsx)("div",{className:"flex h-full w-full items-center justify-center",children:(0,a.jsx)(N.A,{className:"h-16 w-16 animate-spin text-primary"})}):(0,a.jsx)("div",{children:(0,a.jsxs)(h.Zp,{className:"w-full max-w-2xl mx-auto",children:[(0,a.jsxs)(h.aR,{children:[(0,a.jsx)(h.ZB,{children:"Rinnovo Certificato Medico"}),(0,a.jsx)(h.BT,{children:"Carica qui il tuo nuovo certificato medico per mantenere valida la tua copertura assicurativa e l'accesso alle attivit\xe0."})]}),(0,a.jsx)(j.lV,{...U,children:(0,a.jsxs)("form",{onSubmit:U.handleSubmit(G),children:[(0,a.jsx)(h.Wu,{className:"space-y-6",children:(0,a.jsxs)("div",{className:"space-y-4 rounded-md border-2 border-[#4B2E09] p-4",children:[(()=>{if(null==S||!S.expiryDate)return(0,a.jsx)("p",{className:"text-center font-bold text-base mb-2 text-gray-600",children:"Nessun certificato caricato"});{let e=new Date,t=Math.ceil((S.expiryDate.getTime()-e.getTime())/864e5);return t<0?(0,a.jsx)("p",{className:"text-center font-bold text-base mb-2 text-red-600",children:"Certificato scaduto"}):t<=30?(0,a.jsxs)("p",{className:"text-center font-bold text-base mb-2 text-yellow-600",children:["Certificato in scadenza (",t," giorni)"]}):(0,a.jsx)("p",{className:"text-center font-bold text-base mb-2 text-green-600",children:"Certificato in corso di validit\xe0"})}})(),(0,a.jsx)(j.zB,{control:U.control,name:"certificateFile",render:e=>{let{field:t}=e;return(0,a.jsxs)(j.eI,{children:[(0,a.jsx)(j.lR,{className:"block text-center",children:"File del certificato (PDF, JPG, PNG)"}),(0,a.jsx)(j.MJ,{children:(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(v.p,{id:"certificate-file-input",type:"file",accept:".pdf,.jpg,.jpeg,.png",className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",onChange:E}),(0,a.jsx)(b.J,{htmlFor:"certificate-file-input",className:"flex items-center justify-center w-full h-24 border-2 border-dashed border-green-600 rounded-md cursor-pointer hover:bg-muted",children:A?(0,a.jsxs)("div",{className:"flex items-center gap-2 text-green-600",children:[(0,a.jsx)(g.A,{className:"h-5 w-5"}),(0,a.jsx)("span",{children:A})]}):(0,a.jsxs)("div",{className:"flex items-center gap-2 text-muted-foreground",children:[(0,a.jsx)(D.A,{className:"h-5 w-5"}),(0,a.jsx)("span",{children:"Clicca per scegliere un nuovo file"})]})})]})}),(0,a.jsx)(j.C5,{})]})}}),(null==S?void 0:S.fileUrl)&&(0,a.jsx)(p.$,{variant:"outline",asChild:!0,className:"w-full bg-gray-100",children:(0,a.jsxs)(x(),{href:S.fileUrl,target:"_blank",rel:"noopener noreferrer",className:"text-blue-700 flex items-center",children:[(0,a.jsx)(w.A,{className:"mr-2 h-4 w-4 text-blue-700"}),(0,a.jsx)("span",{className:"text-blue-700",children:"Visualizza Certificato Caricato"})]})}),(0,a.jsx)(j.zB,{control:U.control,name:"expiryDate",render:e=>{let{field:t}=e;return(0,a.jsxs)(j.eI,{children:[(0,a.jsx)(j.lR,{children:"Data di scadenza del certificato"}),(0,a.jsx)(j.MJ,{children:(0,a.jsx)(v.p,{type:"date",...t})}),(0,a.jsx)(j.C5,{})]})}})]})}),(0,a.jsx)(h.wL,{children:(0,a.jsxs)(p.$,{type:"submit",className:"w-full bg-green-600 text-white font-bold",disabled:_||!U.formState.isValid,children:[_&&(0,a.jsx)(N.A,{className:"mr-2 h-4 w-4 animate-spin"}),"Aggiorna Certificato e torna alla Dashboard"]})})]})})]})})}}},e=>{e.O(0,[2992,7138,4909,3947,7134,3328,9106,1821,2619,9335,8441,1255,7358],()=>e(e.s=15738)),_N_E=e.O()}]);