(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5349],{70578:(e,a,s)=>{"use strict";s.r(a),s.d(a,{default:()=>E});var t=s(95155),r=s(12115),l=s(20063),i=s(19708),n=s(14585),o=s(13328),c=s(15894),d=s(57368),u=s(67377),m=s(89106),h=s(84668),x=s(52619),b=s.n(x),p=s(86948),f=s(3998),g=s(60406),j=s(91480),v=s(19201),y=s(92033),N=s(36204),w=s(39179),k=s(93169),D=s(7881),A=s(50705),P=s(36304),C=s(18332),S=s(51834),z=s(50909),M=s(76444);function I(e){let{subscription:a,onPurchase:s,isSubmitting:r,hasActiveOrPending:l,onOpenPaymentDialog:i}=e,n=new Date,o=!a.purchaseStartDate||!a.purchaseEndDate||(0,d.d)(n,a.purchaseStartDate.toDate())&&(0,u.Y)(n,a.purchaseEndDate.toDate()),c=a.expiryWarningDate&&(0,d.d)(n,a.expiryWarningDate.toDate());return(0,t.jsxs)(p.Zp,{className:"w-full max-w-lg border-4 bg-gray-50",style:{borderColor:"#0ea5e9"},children:[(0,t.jsxs)(p.aR,{children:[(0,t.jsx)(p.ZB,{className:"text-2xl",children:a.name}),(0,t.jsx)(p.BT,{children:"Acquista l'accesso ai corsi per l'intera stagione sportiva."})]}),(0,t.jsxs)(p.Wu,{className:"space-y-4",children:[c&&!l&&(0,t.jsxs)(C.Fc,{variant:"warning",children:[(0,t.jsx)(g.A,{className:"h-4 w-4"}),(0,t.jsx)(C.XL,{children:"Abbonamento in Scadenza!"}),(0,t.jsx)(C.TN,{children:"Il tuo attuale abbonamento sta per scadere. Acquistalo per non perdere l'accesso ai corsi."})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between text-lg",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Prezzo"}),(0,t.jsxs)("span",{className:"font-bold text-3xl",children:[a.totalPrice.toFixed(2)," €"]})]}),(0,t.jsxs)("div",{className:"w-full text-center text-base font-bold mb-2",style:{color:"#0ea5e9"},children:["Acquistabile dal ",a.purchaseStartDate?(0,m.GP)(a.purchaseStartDate.toDate(),"dd MMMM yyyy",{locale:h.it}):"-"," al ",a.purchaseEndDate?(0,m.GP)(a.purchaseEndDate.toDate(),"dd MMMM yyyy",{locale:h.it}):"-"]}),(0,t.jsxs)("div",{className:"space-y-2 rounded-md border p-4",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Valido dal"}),(0,t.jsx)("span",{className:"font-semibold",children:(0,m.GP)(a.validityStartDate.toDate(),"dd MMMM yyyy",{locale:h.it})})]}),(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Fino al"}),(0,t.jsx)("span",{className:"font-semibold",children:(0,m.GP)(a.validityEndDate.toDate(),"dd MMMM yyyy",{locale:h.it})})]})]}),(0,t.jsxs)("ul",{className:"space-y-2 text-sm pt-2",children:[(0,t.jsxs)("li",{className:"flex items-center",children:[(0,t.jsx)(j.A,{className:"h-4 w-4 mr-2 text-primary flex-shrink-0"}),(0,t.jsx)("span",{className:"text-blue-600",children:"Accesso a tutte le palestre della rete."})]}),(0,t.jsxs)("li",{className:"flex items-center",children:[(0,t.jsx)(v.A,{className:"h-4 w-4 mr-2 text-primary flex-shrink-0"}),(0,t.jsx)("span",{className:"text-blue-600",children:"La copertura assicurativa deve essere gi\xe0 attiva."})]})]})]}),(0,t.jsxs)(p.wL,{className:"flex-col gap-2",children:[(0,t.jsxs)(f.$,{onClick:i,disabled:r||l||!o,className:"w-full text-white font-bold bg-blue-600 hover:bg-blue-700",size:"lg",children:[r?(0,t.jsx)(y.A,{className:"animate-spin mr-2"}):null,l?"Pagamento in fase di approvazione":o?"Acquista Ora":"Non ancora acquistabile"]}),(0,t.jsx)(f.$,{asChild:!0,variant:"outline",className:"w-full bg-transparent border-2",style:{color:"hsl(var(--background))",borderColor:"hsl(var(--background))"},children:(0,t.jsxs)(b(),{href:"/dashboard/subscriptions",children:[(0,t.jsx)(N.A,{className:"mr-2 h-4 w-4"}),"Torna Indietro"]})})]})]})}function E(){let[e]=(0,o.hD)(n.j2),a=(0,l.useRouter)(),{toast:m}=(0,c.dj)(),[h,x]=(0,r.useState)(!0),[g,j]=(0,r.useState)(!1),[v,C]=(0,r.useState)(null),[E,F]=(0,r.useState)(null),[B,_]=(0,r.useState)(null),[L,q]=(0,r.useState)(!1),[V,O]=(0,r.useState)(null),[T,G]=(0,r.useState)(!1),[R,U]=(0,r.useState)([]),[$,W]=(0,r.useState)(0);(0,r.useEffect)(()=>{if(e&&Promise.resolve().then(s.bind(s,19708)).then(a=>{let{collection:t,query:r,onSnapshot:l,where:o}=a;l(r(t(n.db,"users",e.uid,"payments"),o("status","==","failed")),async a=>{a.docChanges().forEach(async a=>{if("modified"===a.type){let r=a.doc.data();if(r.bonusUsed>0&&r.awardId){console.log("[Pagamento fallito] Riaccredito bonus:",r);try{let{refundBonus:a}=await s.e(6717).then(s.bind(s,56717));await a(e.uid,r.awardId,r.bonusUsed);let l=await (0,i.getDocs)(t(n.db,"users",e.uid,"userAwards")),o=(await Promise.all(l.docs.map(async e=>{let a=e.data(),s=a.value||0,t=a.residuo||0;if(!a.value&&a.awardId){let e=await (0,i.getDoc)((0,i.doc)(n.db,"awards",a.awardId));e.exists()&&(t=(e.data().value||0)-(a.usedValue||0))}return{id:e.id,value:t,used:a.used||0===t}}))).filter(e=>!e.used&&e.value>0);U(o),W(o.reduce((e,a)=>e+(a.value||0),0)),m({title:"Bonus riaccreditato",description:"Il tuo bonus di ".concat(r.bonusUsed,"€ \xe8 stato riaccreditato perch\xe9 il pagamento non \xe8 stato accettato."),variant:"success"})}catch(e){console.error("Errore durante il rimborso bonus:",e)}}}})})}),!e)return void x(!1);(async()=>{try{let a=await (0,i.getDocs)((0,i.collection)(n.db,"users",e.uid,"userAwards")),s=(await Promise.all(a.docs.map(async e=>{let a=e.data(),s=a.value||0,t=a.residuo||0;if(!a.value&&a.awardId){let e=await (0,i.getDoc)((0,i.doc)(n.db,"awards",a.awardId));e.exists()&&(t=(e.data().value||0)-(a.usedValue||0))}return{id:e.id,value:t,used:a.used||0===t}}))).filter(e=>!e.used&&e.value>0);U(s),W(s.reduce((e,a)=>e+(a.value||0),0));let[t,r,l]=await Promise.all([(0,i.getDocs)((0,i.query)((0,i.collection)(n.db,"subscriptions"),(0,i.where)("type","==","seasonal"))),(0,i.getDoc)((0,i.doc)(n.db,"users",e.uid)),(0,i.getDoc)((0,i.doc)(n.db,"settings","bankDetails"))]);l.exists()&&_(l.data());let o=t.docs.map(e=>({id:e.id,...e.data()})),c=r.exists()?r.data():null;F(c);let m=new Date,h=null;if(o.length>0){let e=o.find(e=>!e.purchaseStartDate||!e.purchaseEndDate||(0,d.d)(m,e.purchaseStartDate.toDate())&&(0,u.Y)(m,e.purchaseEndDate.toDate()));if(e)h=e;else{let e=o.find(e=>(0,d.d)(m,e.validityStartDate.toDate())&&(0,u.Y)(m,e.validityEndDate.toDate()));if(e)h=e;else{let e=o.filter(e=>e.purchaseStartDate&&(0,d.d)(e.purchaseStartDate.toDate(),m)).sort((e,a)=>e.purchaseStartDate.toMillis()-a.purchaseStartDate.toMillis());e.length>0&&(h=e[0])}}}C(h)}catch(e){console.error("Error fetching dati:",e),m({title:"Errore",description:"Impossibile caricare i dati.",variant:"destructive"})}finally{x(!1)}})()},[e,m]),(0,r.useEffect)(()=>{$>0&&"online"===V&&O(null)},[$,V]);let Z=async(s,t)=>{j(!0);try{if("online"===t&&$>0){m({title:"Metodo di pagamento non valido",description:"Il pagamento online non \xe8 disponibile quando si utilizzano bonus.",variant:"destructive"}),j(!1);return}let r=(0,i.writeBatch)(n.db),l=(0,i.doc)(n.db,"users",e.uid),o=0,c=[],d=s.totalPrice;for(let a of R){if(d<=0)break;let s=Math.min(a.value,d);o+=s,d-=s,c.push(a.id);let t=(0,i.doc)(n.db,"users",e.uid,"userAwards",a.id),l=await (0,i.getDoc)(t);if(l.exists()){let e=l.data(),a=e.value||0,i=(e.usedValue||0)+s,n=Math.max(0,a-i);r.update(t,{used:0===n,usedValue:i,residuo:n})}}r.update(l,{subscriptionAccessStatus:"pending",subscriptionPaymentFailed:!1,activeSubscription:{subscriptionId:s.id,name:s.name,type:s.type,purchasedAt:(0,i.serverTimestamp)(),expiresAt:s.validityEndDate}}),await r.commit();let u=await (0,i.getDocs)((0,i.collection)(n.db,"users",e.uid,"userAwards")),h=(await Promise.all(u.docs.map(async e=>{let a=e.data(),s=a.value||0,t=a.residuo||0;if(!a.value&&a.awardId){let e=await (0,i.getDoc)((0,i.doc)(n.db,"awards",a.awardId));e.exists()&&(t=(e.data().value||0)-(a.usedValue||0))}return{id:e.id,value:t,used:a.used||0===t}}))).filter(e=>!e.used&&e.value>0);U(h),W(h.reduce((e,a)=>e+(a.value||0),0));let x=(0,i.collection)(n.db,"users",e.uid,"payments"),b={createdAt:(0,i.serverTimestamp)(),description:"Abbonamento ".concat(s.name," (").concat(s.totalPrice.toFixed(2)," €)"),amount:Math.max(0,s.totalPrice-o),paymentMethod:t,status:"pending",type:"subscription",userId:e.uid};o>0&&(b.bonusUsed=o,b.awardId=1===c.length?c[0]:c),await (0,i.addDoc)(x,b),m({title:"Richiesta Inviata!",description:o>0?"Pagamento: €".concat(Math.max(0,s.totalPrice-o).toFixed(2),". Bonus usati: €").concat(o.toFixed(2),"."):"La tua richiesta di abbonamento stagionale \xe8 in attesa di approvazione."}),"online"===t&&s.sumupLink&&Math.max(0,s.totalPrice-o)>0&&window.open(s.sumupLink,"_blank"),F(e=>e?{...e,subscriptionAccessStatus:"pending",subscriptionPaymentFailed:!1}:null),o>0&&(U([]),W(0)),q(!1),a.push("/dashboard")}catch(e){console.error("Error purchasing subscription: ",e),m({title:"Errore",description:"Impossibile completare l'acquisto. Riprova.",variant:"destructive"})}finally{j(!1)}};if(h)return(0,t.jsx)("div",{className:"flex h-full w-full items-center justify-center",children:(0,t.jsx)(y.A,{className:"h-16 w-16 animate-spin text-primary"})});let J=(null==E?void 0:E.subscriptionAccessStatus)==="active"||(null==E?void 0:E.subscriptionAccessStatus)==="pending";return(0,t.jsx)("div",{className:"flex w-full flex-col items-center justify-center",children:v?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(I,{subscription:v,onPurchase:Z,isSubmitting:g,hasActiveOrPending:!!J,onOpenPaymentDialog:()=>q(!0)}),(null==E?void 0:E.subscriptionAccessStatus)==="pending"&&(0,t.jsxs)("div",{className:"w-full max-w-lg my-4 p-4 rounded-lg border-2 font-semibold text-base text-center",style:{background:"#FFF6E5",color:"hsl(var(--primary))",borderColor:"hsl(var(--primary))"},children:[(0,t.jsx)("div",{className:"mb-2 text-xl font-bold",children:"Abbonamento in Attesa"}),"Il tuo accesso ai corsi sar\xe0 attivato non appena il pagamento del tuo abbonamento verr\xe0 confermato dalla segreteria."]}),(0,t.jsxs)("div",{className:"w-full max-w-lg my-4 p-4 border-2 rounded-lg bg-green-50",style:{borderColor:"#10b981"},children:[(0,t.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,t.jsx)(w.A,{className:"h-6 w-6 text-yellow-500"}),(0,t.jsx)("span",{className:"font-bold",style:{color:"#059669"},children:"Bonus disponibili:"}),(0,t.jsxs)("span",{className:"text-lg font-bold",style:{color:"#059669"},children:["€",$.toFixed(2)]})]}),R.length>0?(0,t.jsx)("ul",{className:"text-sm",children:R.map(e=>(0,t.jsxs)("li",{className:"flex justify-between",children:[(0,t.jsxs)("span",{className:"font-bold",style:{color:"#059669"},children:["ID: ",e.id]}),(0,t.jsxs)("span",{className:"font-bold",style:{color:"#059669"},children:["Valore: €","number"==typeof e.value?e.value.toFixed(2):"0.00"]})]},e.id))}):(0,t.jsx)("span",{className:"text-muted-foreground",children:"Nessun bonus disponibile"})]}),(0,t.jsx)(S.lG,{open:L,onOpenChange:q,children:(0,t.jsxs)(S.Cf,{className:"bg-gray-100 [&>button]:text-[hsl(var(--background))]",children:[(0,t.jsxs)(S.c7,{children:[(0,t.jsx)(S.L3,{style:{color:"hsl(var(--background))"},children:"Scegli Metodo di Pagamento"}),(0,t.jsxs)(S.rr,{className:"text-base",children:["Prezzo abbonamento: ",$>0?(0,t.jsxs)("span",{style:{textDecoration:"line-through",color:"#888",fontWeight:"bold"},children:["€",v.totalPrice.toFixed(2)]}):(0,t.jsxs)("b",{children:["€",v.totalPrice.toFixed(2)]}),(0,t.jsx)("br",{}),"Bonus utilizzabili: ",(0,t.jsxs)("b",{children:["€",$.toFixed(2)]}),(0,t.jsx)("br",{}),$>=v.totalPrice?(0,t.jsx)("span",{className:"font-bold",style:{color:"#059669"},children:"Il tuo abbonamento \xe8 completamente coperto dai bonus!"}):(0,t.jsxs)("span",{className:"font-bold",style:{color:"#059669"},children:["Prezzo finale dopo bonus: €",Math.max(0,v.totalPrice-$).toFixed(2)]})]})]}),Math.max(0,v.totalPrice-$)>0?(0,t.jsxs)(z.z,{value:V||"",onValueChange:e=>O(e),className:"space-y-4 py-4",children:[(0,t.jsxs)(M.J,{htmlFor:"online",className:"flex cursor-pointer items-start space-x-4 rounded-md border-2 p-4 transition-all bg-white hover:bg-accent/50 has-[:checked]:border-primary has-[:checked]:bg-primary/5 ".concat($>0?"opacity-50 cursor-not-allowed":""),style:{borderColor:"hsl(var(--background))"},children:[(0,t.jsx)(z.C,{value:"online",id:"online",className:"mt-1",style:{borderColor:"hsl(var(--background))"},disabled:$>0}),(0,t.jsxs)("div",{className:"flex-1 space-y-1",children:[(0,t.jsxs)("h4",{className:"font-semibold",style:{color:"hsl(var(--background))"},children:["Online (Carta di Credito)",$>0&&(0,t.jsx)("span",{className:"text-red-500 ml-2",children:"(Non disponibile con bonus)"})]}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:$>0?"Il pagamento online non \xe8 disponibile quando si utilizzano bonus. Utilizza bonifico bancario o pagamento in sede.":"Paga in modo sicuro con SumUp. Verrai reindirizzato al sito del gestore, a pagamento effettuato torna all'app per conferma e concludere l'iscrizione ai corsi."})]}),(0,t.jsx)(k.A,{className:"h-6 w-6 ".concat($>0?"text-gray-400":"text-muted-foreground")})]}),(0,t.jsxs)(M.J,{htmlFor:"bank_transfer",className:"flex cursor-pointer items-start space-x-4 rounded-md border-2 p-4 transition-all bg-white hover:bg-accent/50 has-[:checked]:border-primary has-[:checked]:bg-primary/5",style:{borderColor:"hsl(var(--background))"},children:[(0,t.jsx)(z.C,{value:"bank_transfer",id:"bank_transfer",className:"mt-1",style:{borderColor:"hsl(var(--background))"}}),(0,t.jsxs)("div",{className:"flex-1 space-y-1",children:[(0,t.jsx)("h4",{className:"font-semibold",style:{color:"hsl(var(--background))"},children:"Bonifico Bancario"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"Visualizza i dati per effettuare il bonifico. L'attivazione richiede verifica manuale."})]}),(0,t.jsx)(D.A,{className:"h-6 w-6 text-muted-foreground"})]}),(0,t.jsxs)(M.J,{htmlFor:"in_person",className:"flex cursor-pointer items-start space-x-4 rounded-md border-2 p-4 transition-all bg-white hover:bg-accent/50 has-[:checked]:border-primary has-[:checked]:bg-primary/5",style:{borderColor:"hsl(var(--background))"},children:[(0,t.jsx)(z.C,{value:"in_person",id:"in_person",className:"mt-1",style:{borderColor:"hsl(var(--background))"}}),(0,t.jsxs)("div",{className:"flex-1 space-y-1",children:[(0,t.jsx)("h4",{className:"font-semibold",style:{color:"hsl(var(--background))"},children:"In Sede (Contanti o Bancomat)"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"Paga direttamente in palestra. L'attivazione richiede verifica manuale."})]}),(0,t.jsx)(A.A,{className:"h-6 w-6 text-muted-foreground"})]})]}):(0,t.jsx)("div",{className:"py-4 text-center text-green-700 font-semibold",children:"Il tuo abbonamento \xe8 interamente coperto dai bonus. Nessun pagamento richiesto."}),(0,t.jsxs)(S.Es,{className:"justify-between gap-8 px-4",children:[(0,t.jsx)(f.$,{variant:"ghost",onClick:()=>q(!1),className:"bg-transparent border-2",style:{borderColor:"hsl(var(--background))",color:"hsl(var(--background))"},children:"Annulla"}),(0,t.jsxs)(f.$,{onClick:()=>{0===Math.max(0,v.totalPrice-$)?Z(v,"bonus"):(()=>{if(!v||!V)return m({title:"Selezione mancante",description:"Per favore, scegli un metodo di pagamento.",variant:"destructive"});"bank_transfer"===V?G(!0):Z(v,V)})()},disabled:g,className:"text-white font-bold",style:{backgroundColor:"hsl(var(--primary))"},size:"lg",children:[g&&(0,t.jsx)(y.A,{className:"animate-spin mr-2"}),"Conferma"]})]})]})}),(0,t.jsx)(S.lG,{open:T,onOpenChange:G,children:(0,t.jsxs)(S.Cf,{className:"bg-gray-100 [&>button]:text-[hsl(var(--background))]",children:[(0,t.jsx)(S.c7,{children:(0,t.jsx)(S.L3,{style:{color:"hsl(var(--background))"},children:"Dati per Bonifico Bancario"})}),(0,t.jsxs)("div",{className:"space-y-4 py-4 text-sm",children:[B?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("p",{className:"font-semibold text-black",children:"Intestatario:"}),(0,t.jsx)("p",{className:"text-black",children:B.recipientName})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("p",{className:"font-semibold text-black",children:"Banca:"}),(0,t.jsx)("p",{className:"text-black",children:B.bankName})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("p",{className:"font-semibold text-black",children:"IBAN:"}),(0,t.jsx)("p",{className:"font-mono bg-muted p-2 rounded-md text-black",children:B.iban})]})]}):(0,t.jsx)(y.A,{className:"h-6 w-6 animate-spin"}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("p",{className:"font-semibold text-black",children:"Importo:"}),(0,t.jsxs)("p",{className:"text-black",children:[v.totalPrice.toFixed(2)," €"]})]}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("p",{className:"font-semibold text-black",children:"Causale:"}),(0,t.jsx)("p",{className:"font-mono bg-muted p-2 rounded-md text-black",children:"".concat(v.name," ").concat((null==E?void 0:E.name)||""," ").concat((null==E?void 0:E.surname)||"").trim()})]})]}),(0,t.jsx)(S.Es,{children:(0,t.jsx)(f.$,{onClick:()=>{v&&(Z(v,"bank_transfer"),a.push("/dashboard")),G(!1)},className:"w-full bg-green-600 hover:bg-green-700 text-white font-bold",children:"Ho copiato i dati, invia richiesta"})})]})})]}):(0,t.jsxs)(p.Zp,{className:"w-full max-w-lg",children:[(0,t.jsxs)(p.aR,{children:[(0,t.jsx)(p.ZB,{children:"Nessun Abbonamento Disponibile"}),(0,t.jsx)(p.BT,{children:"Al momento non ci sono abbonamenti stagionali acquistabili. Contatta la segreteria per maggiori informazioni."})]}),(0,t.jsx)(p.Wu,{children:(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-48 text-center text-muted-foreground border-2 border-dashed rounded-lg",children:[(0,t.jsx)(P.A,{className:"h-16 w-16 mb-4"}),(0,t.jsx)("p",{children:"Torna a trovarci presto!"})]})}),(0,t.jsx)(p.wL,{children:(0,t.jsx)(f.$,{asChild:!0,variant:"outline",className:"w-full",children:(0,t.jsxs)(b(),{href:"/dashboard/subscriptions",children:[(0,t.jsx)(N.A,{className:"mr-2 h-4 w-4"}),"Torna Indietro"]})})})]})})}},90784:(e,a,s)=>{Promise.resolve().then(s.bind(s,70578))}},e=>{e.O(0,[2992,7138,4909,3947,7134,3328,9106,1930,2445,531,2619,7079,5899,9002,8441,1255,7358],()=>e(e.s=90784)),_N_E=e.O()}]);