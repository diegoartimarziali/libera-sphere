(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[309],{18332:(e,a,t)=>{"use strict";t.d(a,{Fc:()=>o,TN:()=>d,XL:()=>c});var s=t(95155),i=t(12115),l=t(83101),r=t(64269);let n=(0,l.F)("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",warning:"border-yellow-500/50 text-yellow-700 bg-yellow-50 dark:bg-yellow-950 dark:text-yellow-400 [&>svg]:text-yellow-500 dark:[&>svg]:text-yellow-400",info:"border-blue-500/50 text-blue-700 bg-blue-50 dark:bg-blue-950 dark:text-blue-400 [&>svg]:text-blue-500 dark:[&>svg]:text-blue-400",success:"border-green-500/50 text-green-700 bg-green-50 dark:bg-green-950 dark:text-green-400 [&>svg]:text-green-500 dark:[&>svg]:text-green-400"}},defaultVariants:{variant:"default"}}),o=i.forwardRef((e,a)=>{let{className:t,variant:i,...l}=e;return(0,s.jsx)("div",{ref:a,role:"alert",className:(0,r.cn)(n({variant:i}),t),...l})});o.displayName="Alert";let c=i.forwardRef((e,a)=>{let{className:t,...i}=e;return(0,s.jsx)("h5",{ref:a,className:(0,r.cn)("mb-1 font-medium leading-none tracking-tight",t),...i})});c.displayName="AlertTitle";let d=i.forwardRef((e,a)=>{let{className:t,...i}=e;return(0,s.jsx)("div",{ref:a,className:(0,r.cn)("text-sm [&_p]:leading-relaxed",t),...i})});d.displayName="AlertDescription"},58900:(e,a,t)=>{"use strict";t.r(a),t.d(a,{default:()=>A});var s=t(95155),i=t(12115),l=t(20063),r=t(52619),n=t.n(r),o=t(15894),c=t(48182),d=t(86948),m=t(3998),u=t(76444),p=t(89106),x=t(19056),h=t(84668),b=t(86933),f=t(59338),v=t(59729),g=t(36304),j=t(50705),y=t(93169),N=t(28127),w=t(14585),z=t(13328),D=t(19708),S=t(92033),C=t(50909),L=t(18332),E=t(64269);let k=e=>{let{label:a,value:t,icon:i}=e;return t?(0,s.jsxs)("div",{className:"flex items-start",children:[i&&(0,s.jsx)("div",{className:"w-5 text-muted-foreground mt-0.5",children:i}),(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:justify-between w-full ".concat(i?"ml-3":""),children:[(0,s.jsx)("dt",{className:"font-medium text-muted-foreground ".concat(a.match(/Disciplina|Grado|Palestra|Lezione/)?"text-[#1e3a8a]":""),children:a}),(0,s.jsx)("dd",{className:"mt-1 text-foreground sm:mt-0 sm:text-right",children:t})]})]}):null};function T(e){let{onNext:a,user:t}=e,{toast:r}=(0,o.dj)();(0,l.useRouter)();let[c,x]=(0,i.useState)(!0),[j,y]=(0,i.useState)(null),[N,z]=(0,i.useState)(null),[T,I]=(0,i.useState)(null),[P,A]=(0,i.useState)(null),[M,_]=(0,i.useState)([]),[B,R]=(0,i.useState)(null),[Z,G]=(0,i.useState)([]);return((0,i.useEffect)(()=>{let e=async()=>{if(!t)return void x(!1);x(!0),_([]);try{let e=(0,D.doc)(w.db,"users",t.uid),a=await (0,D.getDoc)(e);if(a.exists()){let e=a.data(),t=e.discipline,s=e.gym;if(y(t),z(s),t&&s){let e=(0,D.doc)(w.db,"gyms",s),a=await (0,D.getDoc)(e);if(a.exists()){let e=a.data();I(e.name)}let i=(0,D.doc)(w.db,"orarigruppi",s),l=await (0,D.getDoc)(i);l.exists()?A(l.data().lezioniselezione||"Orario non disponibile"):A("Orario non disponibile");let r=D.Timestamp.now(),n=(0,D.query)((0,D.collection)(w.db,"events"),(0,D.where)("type","==","lesson"),(0,D.where)("status","==","confermata"),(0,D.where)("gymId","==",s),(0,D.where)("discipline","==",t),(0,D.where)("startTime",">=",r),(0,D.orderBy)("startTime","asc"),(0,D.limit)(20)),o=(await (0,D.getDocs)(n)).docs.map(e=>({id:e.id,title:e.data().title,startTime:e.data().startTime,endTime:e.data().endTime}));_(o)}else r({title:"Dati mancanti",description:"Disciplina o palestra non impostate nel tuo profilo.",variant:"destructive"})}}catch(e){console.error("Error fetching gym/schedule data:",e),r({title:"Errore di connessione",description:"Impossibile recuperare i dati delle lezioni.",variant:"destructive"})}finally{x(!1)}};t&&e()},[t]),(0,i.useEffect)(()=>{if(B&&M.length>0){let e=M.findIndex(e=>e.id===B);-1!==e&&M.length>=e+3?G(M.slice(e,e+3)):-1!==e?(G([]),r({variant:"destructive",title:"Lezioni insufficienti",description:"Non ci sono abbastanza lezioni consecutive disponibili a partire da questa data per completare il pacchetto di prova. Scegli una data di inizio precedente."})):G([])}else G([])},[B,M,r]),c)?(0,s.jsxs)(d.Zp,{children:[(0,s.jsx)(d.aR,{children:(0,s.jsx)(d.ZB,{children:"Caricamento Lezioni"})}),(0,s.jsx)(d.Wu,{className:"flex h-64 items-center justify-center",children:(0,s.jsx)(S.A,{className:"h-8 w-8 animate-spin"})})]}):T?0!==M.length||c?(0,s.jsxs)(d.Zp,{children:[(0,s.jsxs)(d.aR,{children:[(0,s.jsxs)(d.ZB,{children:["Scegli la Prima lezione di ",j]}),(0,s.jsx)(d.BT,{children:"Selezionando la prima lezione, verranno automaticamente prenotate le ".concat(2," successive disponibili per la tua categoria.")})]}),(0,s.jsxs)(d.Wu,{className:"space-y-6",children:[(0,s.jsxs)(L.Fc,{variant:"info",className:"w-full text-center",children:[(0,s.jsx)(b.A,{className:"h-4 w-4"}),(0,s.jsx)(L.XL,{className:"font-semibold",children:"Curioso di sapere cosa ne pensano gli altri?"}),(0,s.jsx)(L.TN,{children:(0,s.jsx)(m.$,{asChild:!0,variant:"link",className:"p-0 h-auto",children:(0,s.jsx)(n(),{href:"/dashboard/reviews",className:"font-bold",children:"Leggi le recensioni di chi ha gi\xe0 provato"})})})]}),(0,s.jsxs)("div",{className:"space-y-4 rounded-md border p-4",style:{borderColor:"hsl(var(--medical-upload-text))",borderWidth:2},children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-center",children:"La tua scelta"}),(0,s.jsxs)("dl",{className:"space-y-2",children:[(0,s.jsx)(k,{label:"Disciplina",value:(0,s.jsx)("span",{className:"font-bold",style:{color:"hsl(var(--medical-upload-text))"},children:j}),icon:(0,s.jsx)(f.A,{size:16})}),(0,s.jsx)(k,{label:"Palestra",value:(0,s.jsx)("span",{className:"font-bold",style:{color:"hsl(var(--medical-upload-text))"},children:N?"".concat(N," - ").concat(T):""}),icon:(0,s.jsx)(v.A,{size:16})}),(0,s.jsx)(k,{label:"Orario Lezioni",value:(0,s.jsx)("span",{className:"font-bold",style:{color:"hsl(var(--medical-upload-text))"},children:P}),icon:(0,s.jsx)(g.A,{size:16})})]})]}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-center",children:"Scegli il giorno della tua prima lezione"}),(0,s.jsx)("p",{className:"text-center text-sm text-muted-foreground mt-1",children:"Le altre lezioni verranno scelte dal sistema in base alla disponibilit\xe0."}),(0,s.jsx)(C.z,{value:B||"",onValueChange:R,className:"grid grid-cols-2 gap-3 sm:grid-cols-4",children:M.map(e=>{let a=e.id,t=Z.some(a=>a.id===e.id),i=B===a;return(0,s.jsxs)(u.J,{htmlFor:a,className:(0,E.cn)("flex flex-col items-center justify-center rounded-md p-3 cursor-pointer hover:bg-accent/80 transition-all",i||t?"border-4 border-sky-600 bg-sky-100":"border-2 border-sky-300"),children:[(0,s.jsx)(C.C,{value:a,id:a,className:"sr-only"}),(0,s.jsx)("span",{className:"font-semibold capitalize",children:(0,p.GP)(e.startTime.toDate(),"EEEE",{locale:h.it})}),(0,s.jsx)("span",{className:"text-sm",children:(0,p.GP)(e.startTime.toDate(),"dd MMMM yyyy")}),(0,s.jsx)("span",{className:"text-xs text-muted-foreground",children:(0,p.GP)(e.startTime.toDate(),"HH:mm")})]},a)})})]})]}),(0,s.jsx)(d.wL,{className:"justify-center",children:(0,s.jsx)(m.$,{onClick:()=>j&&N&&T&&0!==Z.length?Z.length<3?void r({variant:"destructive",title:"Lezioni insufficienti",description:"Non ci sono abbastanza lezioni disponibili per completare il ciclo di prova da questa data. Scegli un'altra data di inizio."}):void a({gymId:N,gymName:T,discipline:j,selectionLessonsSchedule:P||void 0,trialLessons:Z.map(e=>({eventId:e.id,startTime:e.startTime,endTime:e.endTime}))}):void r({variant:"destructive",title:"Selezione Incompleta",description:"Devi selezionare una lezione valida per cui ci siano abbastanza prove disponibili."}),disabled:!B||0===Z.length,className:"w-full font-bold",style:{backgroundColor:"#16a34a",color:"#fff"},children:"Scegli il Pagamento"})})]}):(0,s.jsxs)(d.Zp,{children:[(0,s.jsx)(d.aR,{children:(0,s.jsx)(d.ZB,{children:"Lezioni non disponibili"})}),(0,s.jsx)(d.Wu,{children:(0,s.jsx)("p",{children:"Al momento non ci sono lezioni di selezione disponibili per la disciplina e la palestra che hai scelto. Contatta la segreteria per maggiori informazioni."})})]}):(0,s.jsxs)(d.Zp,{children:[(0,s.jsx)(d.aR,{children:(0,s.jsx)(d.ZB,{children:"Dati non trovati"})}),(0,s.jsx)(d.Wu,{children:(0,s.jsx)("p",{children:"Non \xe8 stato possibile caricare le informazioni sulla palestra. Torna indietro e riprova."})})]})}function I(e){let{onNext:a,onBack:t,fee:l}=e,[r,n]=(0,i.useState)(null);return(0,s.jsxs)(d.Zp,{children:[(0,s.jsxs)(d.aR,{children:[(0,s.jsx)(d.ZB,{children:"Metodo di Pagamento"}),(0,s.jsxs)(d.BT,{children:["Scegli come preferisci pagare la quota di ",(0,s.jsxs)("span",{className:"font-bold",children:["iscrizione di ",l?"".concat(l.price,"€"):"...","."]})]})]}),(0,s.jsx)(d.Wu,{children:(0,s.jsxs)(C.z,{value:r?String(r):"",onValueChange:e=>n(e),className:"space-y-4",children:[(0,s.jsxs)(u.J,{htmlFor:"in_person",className:"flex cursor-pointer items-start space-x-4 rounded-md border p-4 transition-all hover:bg-accent/50 has-[:checked]:border-primary has-[:checked]:bg-primary/5",children:[(0,s.jsx)(C.C,{value:"in_person",id:"in_person",className:"mt-1"}),(0,s.jsxs)("div",{className:"flex-1 space-y-1",children:[(0,s.jsx)("h4",{className:"font-semibold",children:"In Palestra (Contanti o Bancomat)"}),(0,s.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Potrai saldare la quota di ",l?"".concat(l.price,"€"):"..."," direttamente presso la nostra sede prima dell'inizio delle lezioni."]})]}),(0,s.jsx)(j.A,{className:"h-6 w-6 text-muted-foreground"})]}),(0,s.jsxs)(u.J,{htmlFor:"online",className:"flex cursor-pointer items-start space-x-4 rounded-md border p-4 transition-all hover:bg-accent/50 has-[:checked]:border-primary has-[:checked]:bg-primary/5",children:[(0,s.jsx)(C.C,{value:"online",id:"online",className:"mt-1"}),(0,s.jsxs)("div",{className:"flex-1 space-y-1",children:[(0,s.jsx)("h4",{className:"font-semibold",children:"Online (Carta di Credito)"}),(0,s.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Paga in modo sicuro e veloce la quota di ",l?"".concat(l.price,"€"):"..."," con la tua carta tramite SumUp. Verrai indirizzato al sito sumup, ",(0,s.jsxs)("span",{className:"font-bold",children:["quando hai effettuato il pagamento con sumup ",(0,s.jsx)("span",{className:"underline",children:"torna all'App per concludere l'iscrizione."})]})]})]}),(0,s.jsx)(y.A,{className:"h-6 w-6 text-muted-foreground"})]})]})}),(0,s.jsx)(d.wL,{className:"justify-center",children:(0,s.jsx)(m.$,{onClick:()=>a(r),disabled:!r,className:"font-bold",style:{backgroundColor:"#f97316",color:"#fff"},children:"Prosegui"})})]})}function P(e){var a;let{formData:t,gymSelection:i,paymentMethod:l,onComplete:r,isSubmitting:n,fee:o,lastGrade:c}=e;return o&&c?(0,s.jsxs)(d.Zp,{children:[(0,s.jsxs)(d.aR,{children:[(0,s.jsx)(d.ZB,{children:"Riepilogo e Conferma"}),(0,s.jsx)(d.BT,{children:"Controlla i dati e la scelta del pagamento e completa l'iscrizione."})]}),(0,s.jsxs)(d.Wu,{className:"space-y-6",children:[(0,s.jsx)("div",{className:"space-y-4 rounded-md border p-4",children:(0,s.jsxs)("div",{className:"bg-[#f8f6f3] border-2 border-[hsl(var(--medical-upload-text))] rounded-lg p-4",children:[(0,s.jsx)("h3",{className:"font-semibold text-lg text-center",children:"Dati Anagrafici"}),(0,s.jsxs)("dl",{className:"space-y-2",children:[(0,s.jsx)(k,{label:"Nome",value:(0,s.jsx)("span",{className:"font-bold",style:{color:"hsl(var(--medical-upload-text))"},children:t.name})}),(0,s.jsx)(k,{label:"Cognome",value:(0,s.jsx)("span",{className:"font-bold",style:{color:"hsl(var(--medical-upload-text))"},children:t.surname})}),(0,s.jsx)(k,{label:"Codice Fiscale",value:(0,s.jsx)("span",{className:"font-bold",style:{color:"hsl(var(--medical-upload-text))"},children:t.taxCode})}),(0,s.jsx)(k,{label:"Data di Nascita",value:(0,s.jsx)("span",{className:"font-bold",style:{color:"hsl(var(--medical-upload-text))"},children:t.birthDate?(0,p.GP)((0,x.H)(t.birthDate),"PPP",{locale:h.it}):""})}),(0,s.jsx)(k,{label:"Luogo di Nascita",value:(0,s.jsx)("span",{className:"font-bold",style:{color:"hsl(var(--medical-upload-text))"},children:t.birthPlace})}),(0,s.jsx)(k,{label:"Indirizzo",value:(0,s.jsx)("span",{className:"font-bold",style:{color:"hsl(var(--medical-upload-text))"},children:"".concat(t.address,", ").concat(t.streetNumber)})}),(0,s.jsx)(k,{label:"Citt\xe0",value:(0,s.jsx)("span",{className:"font-bold",style:{color:"hsl(var(--medical-upload-text))"},children:"".concat(t.city," (").concat(t.province,"), ").concat(t.zipCode)})}),(0,s.jsx)(k,{label:"Email",value:(0,s.jsx)("span",{className:"font-bold",style:{color:"hsl(var(--medical-upload-text))"},children:null==(a=w.j2.currentUser)?void 0:a.email})}),(0,s.jsx)(k,{label:"Telefono",value:(0,s.jsx)("span",{className:"font-bold",style:{color:"hsl(var(--medical-upload-text))"},children:t.phone})})]})]})}),t.isMinor&&t.parentData&&(0,s.jsxs)("div",{className:"space-y-4 rounded-md border p-4",children:[(0,s.jsx)("h3",{className:"font-semibold text-lg",children:"Dati Genitore/Tutore"}),(0,s.jsxs)("dl",{className:"space-y-2",children:[(0,s.jsx)(k,{label:"Nome",value:t.parentData.parentName}),(0,s.jsx)(k,{label:"Cognome",value:t.parentData.parentSurname}),(0,s.jsx)(k,{label:"Codice Fiscale",value:t.parentData.parentTaxCode})]})]}),(0,s.jsx)("div",{className:"space-y-4 rounded-md border p-4",children:(0,s.jsxs)("div",{className:"bg-[#eaf6fb] border-2 border-[#1e3a8a] rounded-lg p-4",children:[(0,s.jsx)("h3",{className:"font-semibold text-lg text-center text-[#1e3a8a]",children:"Lezioni di Prova"}),(0,s.jsxs)("dl",{className:"space-y-3",children:[(0,s.jsx)(k,{label:"Disciplina",value:(0,s.jsx)("span",{className:"font-bold text-[#1e3a8a]",children:i.discipline}),icon:(0,s.jsx)(f.A,{size:16})}),(0,s.jsx)(k,{label:"Grado",value:(0,s.jsx)("span",{className:"font-bold text-[#1e3a8a]",children:c}),icon:(0,s.jsx)(f.A,{size:16})}),(0,s.jsx)(k,{label:"Palestra",value:(0,s.jsx)("span",{className:"font-bold text-[#1e3a8a]",children:"".concat(i.gymId," - ").concat(i.gymName)}),icon:(0,s.jsx)(v.A,{size:16})}),i.trialLessons.map((e,a)=>(0,s.jsx)(k,{label:"".concat(a+1,"\xaa Lezione"),value:(0,s.jsx)("span",{className:"font-bold text-[#1e3a8a]",children:"".concat((0,p.GP)(e.startTime.toDate(),"EEEE d MMMM",{locale:h.it})," ").concat(i.selectionLessonsSchedule?"- Orario: ".concat(i.selectionLessonsSchedule):"")}),icon:(0,s.jsx)(N.A,{size:16})},a))]})]})}),(0,s.jsxs)("div",{className:"bg-[#f8f6f3] border-2 border-[hsl(var(--medical-upload-text))] rounded-lg p-4",children:[(0,s.jsx)("h3",{className:"font-semibold text-lg text-center",children:"Metodo di Pagamento"}),(0,s.jsxs)("dl",{className:"space-y-2",children:[(0,s.jsx)(k,{label:"Metodo Scelto",value:(0,s.jsx)("span",{className:"font-bold text-[#ea580c]",children:"in_person"===String(l)?"In Palestra":"Online con Carta"})}),(0,s.jsx)(k,{label:"in_person"===String(l)?"Importo da Pagare":"Importo",value:(0,s.jsx)("span",{className:"font-bold text-[#ea580c]",children:"in_person"===String(l)?"".concat(o.price.toFixed(2)," €"):"".concat(o.price.toFixed(2)," € (In attesa di conferma)")})})]})]})]}),(0,s.jsx)(d.wL,{children:(0,s.jsxs)(m.$,{onClick:r,disabled:n,className:"w-full bg-[#6b3f19] hover:bg-[#4e2d13] text-[#ffd700] font-bold border-2 border-[#bfa100]",children:[n&&(0,s.jsx)(S.A,{className:"mr-2 h-4 w-4 animate-spin"}),"Completa Iscrizione"]})})]}):(0,s.jsx)(d.Zp,{children:(0,s.jsx)(d.Wu,{className:"flex justify-center items-center h-48",children:(0,s.jsx)(S.A,{className:"h-8 w-8 animate-spin"})})})}function A(){let[e,a]=(0,i.useState)(1),[t,r]=(0,i.useState)(null),[n,m]=(0,i.useState)(null),[u,h]=(0,i.useState)(null),[b,f]=(0,i.useState)(null),[v,g]=(0,i.useState)(null),[j,y]=(0,i.useState)(!0),{toast:N}=(0,o.dj)(),C=(0,l.useRouter)(),[L]=(0,z.hD)(w.j2),[E,k]=(0,i.useState)(!1),[A,M]=(0,i.useState)(null),[_,B]=(0,i.useState)(new Map),[R,Z]=(0,i.useState)([]);(0,i.useEffect)(()=>{(async()=>{if(!L)return y(!1);try{let t=(0,D.doc)(w.db,"fees","trial"),s=(0,D.doc)(w.db,"settings","enrollment"),i=(0,D.doc)(w.db,"users",L.uid),l=(0,D.collection)(w.db,"users",L.uid,"payments"),n=await (0,D.getDocs)((0,D.collection)(w.db,"gyms")),o=await (0,D.getDocs)((0,D.collection)(w.db,"users/".concat(L.uid,"/awards"))),[c,d,u]=await Promise.all([(0,D.getDoc)(t),(0,D.getDoc)(s),(0,D.getDoc)(i)]),x=new Map;n.forEach(e=>x.set(e.id,{name:e.data().name})),B(x);let b=o.docs.map(e=>({id:e.id,...e.data()}));if(Z(b),c.exists()?f(c.data()):N({title:"Errore",description:"Impossibile caricare i dati della quota.",variant:"destructive"}),d.exists()?g({enrollment:d.data()}):N({title:"Errore di configurazione",description:"Impostazioni per le iscrizioni non trovate.",variant:"destructive"}),u.exists()){let t,s=u.data(),i=(0,D.doc)(w.db,"users/".concat(L.uid,"/trialLessons/main")),n=await (0,D.getDoc)(i),o=[];if(n.exists()){let e=n.data();o=e.lessons||[],t=e.trialStatus,e.trialExpiryDate}if("pending_payment"===t&&o.length>0){let t=(0,D.query)(l,(0,D.where)("type","==","trial"),(0,D.where)("status","==","pending"),(0,D.orderBy)("createdAt","desc"),(0,D.limit)(1)),i=await (0,D.getDocs)(t);if(!i.empty){var e;let t=i.docs[0].data();h(t.paymentMethod),r({name:s.name||"",surname:s.surname||"",taxCode:s.taxCode||"",birthDate:s.birthDate?(0,p.GP)(s.birthDate.toDate(),"yyyy-MM-dd"):"",birthPlace:s.birthPlace||"",address:s.address||"",streetNumber:s.streetNumber||"",city:s.city||"",zipCode:s.zipCode||"",province:s.province||"",phone:s.phone||"",isMinor:s.isMinor||!1,parentData:s.parentData});let l=(0,D.doc)(w.db,"orarigruppi",s.gym),n=await (0,D.getDoc)(l),c=n.exists()?n.data().lezioniselezione:void 0;m({gymId:s.gym,gymName:(null==(e=x.get(s.gym))?void 0:e.name)||s.gym,discipline:s.discipline,trialLessons:o,selectionLessonsSchedule:c}),M(s.lastGrade),a(4)}}}}catch(e){console.error("Error fetching initial data:",e),N({title:"Errore di connessione",description:"Impossibile recuperare i dati. Riprova.",variant:"destructive"})}finally{y(!1)}})()},[L,N]);let G=async e=>{if(L){k(!0);try{let t=(0,D.doc)(w.db,"users",L.uid),s={name:e.name,surname:e.surname,birthPlace:e.birthPlace,birthDate:e.birthDate?D.Timestamp.fromDate((0,x.H)(e.birthDate)):null,taxCode:e.taxCode,address:e.address,streetNumber:e.streetNumber,zipCode:e.zipCode,city:e.city,province:e.province,phone:e.phone,isMinor:e.isMinor,parentData:e.isMinor?e.parentData:null};await (0,D.updateDoc)(t,s),r(e),n&&u?a(4):a(2)}catch(e){N({title:"Errore",description:"Impossibile salvare i dati anagrafici.",variant:"destructive"})}finally{k(!1)}}},q=async e=>{if(L){k(!0);try{let s=(0,D.doc)(w.db,"users",L.uid),i=await (0,D.getDoc)(s);if(!i.exists())throw Error("User not found");let l=i.data(),r=(null==l?void 0:l.hasPracticedBefore)==="yes",n=null==l?void 0:l.discipline,o=null==l?void 0:l.lastGrade,c="";if(r&&n===e.discipline&&o)c=o;else{var t;let a=(0,D.doc)(w.db,"config",e.discipline.toLowerCase()),s=await (0,D.getDoc)(a);if(s.exists()&&(null==(t=s.data().grades)?void 0:t[0])){let a=s.data().grades[0];c="Karate"===e.discipline?"Cintura ".concat(a):a}else throw Error("Grado di default non trovato per ".concat(e.discipline))}let d=(0,D.doc)(w.db,"users",L.uid,"trialLessons","main");await (0,D.setDoc)(d,{lessons:e.trialLessons,trialStatus:"pending_payment",trialExpiryDate:e.trialLessons.length>1?e.trialLessons[2].endTime:e.trialLessons[0].endTime||null}),await (0,D.updateDoc)(s,{lastGrade:c}),M(c),m(e),a(3)}catch(e){N({title:"Errore",description:"Impossibile salvare la scelta delle lezioni: ".concat(e instanceof Error?e.message:"sconosciuto"),variant:"destructive"})}finally{k(!1)}}},F=async e=>{if(L&&n&&b){k(!0);try{var t;let s,i=(0,D.writeBatch)(w.db);(0,D.doc)(w.db,"users",L.uid);let l=(0,D.collection)(w.db,"users",L.uid,"payments"),r=(0,D.query)(l,(0,D.where)("type","==","trial"),(0,D.where)("status","==","pending"),(0,D.limit)(1));if((await (0,D.getDocs)(r)).empty){let a=(0,D.doc)(l);i.set(a,{userId:L.uid,createdAt:(0,D.serverTimestamp)(),amount:b.price,description:b.name,type:"trial",status:"pending",paymentMethod:e})}let o=(0,D.doc)(w.db,"users",L.uid,"trialLessons","main");await (0,D.updateDoc)(o,{trialStatus:"pending_payment",trialExpiryDate:n.trialLessons.length>1?n.trialLessons[2].endTime:n.trialLessons[0].endTime||null});let c=(null==(t=_.get(n.gymId))?void 0:t.name.toLowerCase())||"";if(c.includes("verres")?s=R.find(e=>e.name.includes("3 Lezioni")):(c.includes("aosta")||c.includes("villeneuve"))&&(s=R.find(e=>e.name.includes("5 Lezioni"))),s){let e=(0,D.doc)(w.db,"users",L.uid,"userAwards",s.id);i.set(e,{assignedAt:(0,D.serverTimestamp)(),awardId:s.id,name:s.name,value:s.value,residuo:s.value,used:!1,usedValue:0,reason:"Iscrizione lezioni di prova"})}await i.commit(),h(e),"online"===String(e)&&(null==b?void 0:b.sumupLink)&&window.open(b.sumupLink,"_blank"),a(4)}catch(e){N({title:"Errore",description:"Impossibile avviare il pagamento.",variant:"destructive"})}finally{k(!1)}}},O=async()=>{if(!L)return void N({title:"Errore",description:"Utente non autenticato.",variant:"destructive"});k(!0);try{localStorage.getItem("showDataCorrectionMessageExpired")||sessionStorage.setItem("showDataCorrectionMessage",new Date().toISOString()),N({title:"Iscrizione Inviata!",description:"La tua richiesta \xe8 stata inviata con successo. Verrai reindirizzato."}),C.replace("/dashboard"),window.location.href="/dashboard"}catch(e){console.error("Errore durante il completamento dell'iscrizione:",e),N({title:"Errore",description:"Impossibile completare l'iscrizione. Riprova.",variant:"destructive"})}finally{k(!1)}};return j||void 0===L?(0,s.jsx)("div",{className:"flex h-full w-full items-center justify-center",children:(0,s.jsx)(S.A,{className:"h-16 w-16 animate-spin text-primary"})}):null===L?(0,s.jsx)("div",{className:"flex h-full w-full items-center justify-center",children:(0,s.jsxs)(d.Zp,{children:[(0,s.jsx)(d.aR,{children:(0,s.jsx)(d.ZB,{children:"Accesso richiesto"})}),(0,s.jsx)(d.Wu,{children:(0,s.jsx)("p",{children:"Devi essere autenticato per accedere a questa pagina."})})]})}):(0,s.jsxs)("div",{className:"flex w-full flex-col items-center",children:[(0,s.jsxs)("div",{className:"mb-8 text-center",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold",children:"Iscrizione alle Lezioni di Selezione"}),(0,s.jsx)("p",{className:"mt-2 text-sm",children:"Completa la procedura per iscriverti."})]}),(0,s.jsxs)("div",{className:"w-full max-w-3xl",children:[1===e&&(0,s.jsx)(c.t,{title:"Dati Anagrafici",description:"Completa le tue informazioni personali per procedere con l'iscrizione. Questi dati verranno salvati per future iscrizioni.",buttonText:"Prosegui",onFormSubmit:G}),2===e&&L&&(0,s.jsx)(T,{onNext:q,user:L}),3===e&&(0,s.jsx)(I,{onNext:F,onBack:()=>a(2),fee:b}),4===e&&t&&u&&n&&(0,s.jsx)(P,{formData:t,gymSelection:n,paymentMethod:u,onComplete:O,isSubmitting:E,fee:b,lastGrade:A})]})]})}},77104:(e,a,t)=>{Promise.resolve().then(t.bind(t,58900))}},e=>{e.O(0,[2992,7138,4909,3947,7134,3328,9106,1930,2445,1821,2619,7079,3012,4915,8441,1255,7358],()=>e(e.s=77104)),_N_E=e.O()}]);